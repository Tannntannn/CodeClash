rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() {
      return request.auth != null;
    }
    
    function isOwner(classDoc) {
      return isAuthed() && classDoc.data.createdBy == request.auth.uid;
    }
    
    function isEnrolled(classCode) {
      return isAuthed() && exists(/databases/$(database)/documents/Users/$(request.auth.uid)/MyJoinedClasses/$(classCode));
    }
    
    // Users (capital U)
    match /Users/{userId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && userId == request.auth.uid;
      
      match /MyJoinedClasses/{classCode} {
        // User can read/write their own joined classes
        allow read, write: if isAuthed() && userId == request.auth.uid;
        // Teacher (class owner) can also write to approve join requests
        allow write: if isAuthed() && isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
      
      match /Notifications/{notificationId} {
        // User can read their own notifications
        allow read: if isAuthed() && userId == request.auth.uid;
        // Any authenticated user can write (so teachers can send notifications to students)
        allow write: if isAuthed();
      }
    }
    
    // users (lowercase) â€“ keep for existing data
    match /users/{userId} {
      allow read: if isAuthed();
      allow write: if isAuthed() && userId == request.auth.uid;
      
      match /MyJoinedClasses/{classCode} {
        // User can read/write their own joined classes
        allow read, write: if isAuthed() && userId == request.auth.uid;
        // Teacher (class owner) can also write to approve join requests
        allow write: if isAuthed() && isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
      
      match /Notifications/{notificationId} {
        // User can read their own notifications
        allow read: if isAuthed() && userId == request.auth.uid;
        // Any authenticated user can write (so teachers can send notifications to students)
        allow write: if isAuthed();
      }
    }
    
    // Classes
    match /Classes/{classCode} {
      // Read class if owner, enrolled, or any signed-in user (needed to join by code)
      allow read: if isOwner(resource) || isEnrolled(classCode) || isAuthed();
      
      // Only owner can create/update/delete class metadata
      allow write: if isOwner(resource) || (request.resource != null && isOwner(request.resource));
      
      // Lessons subcollection (needed for lesson status reads)
      match /Lessons/{lessonName} {
        allow read: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || isEnrolled(classCode);
        // Only owner updates lock/unlock
        allow write: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
      
      // Students subcollection
      match /Students/{studentId} {
        // Owner or that student can read/write/delete their student doc (join uses this)
        allow read, write, delete: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || (isAuthed() && studentId == request.auth.uid);
        
        // Attempts per lesson+activity
        match /Attempts/{attemptKey} {
          allow read, write: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || (isAuthed() && studentId == request.auth.uid);
        }
        
        // Progress per lesson
        match /Progress/{lessonName} {
          allow read, write: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || (isAuthed() && studentId == request.auth.uid);
        }
      }
      
      // students collection (lowercase s) - for compatibility
      match /students/{studentId} {
        // Owner or that student can read/write/delete their student doc
        allow read, write, delete: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || (isAuthed() && studentId == request.auth.uid);
      }
      
      // ADDED: JoinRequests collection for teacher approval system
      match /JoinRequests/{studentId} {
        // Students can create/read/update their own join requests (to retry after rejection)
        allow read, write: if isAuthed() && studentId == request.auth.uid;
        // Teachers (class owners) can read/write/delete all join requests
        allow read, write, delete: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
      
      // ADDED: LeaveRequests collection for teacher approval system
      match /LeaveRequests/{studentId} {
        // Students can create/read/update their own leave requests (to retry after rejection)
        allow read, write: if isAuthed() && studentId == request.auth.uid;
        // Teachers (class owners) can read/write/delete all leave requests
        allow read, write, delete: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
      
      // ADDED: StudentCode collection for compiler mode
      match /StudentCode/{docId} {
        // Allow students to read/write/delete if they are enrolled in the class
        allow read, write, delete: if isAuthed() && isEnrolled(classCode);
        
        // Teachers can also read/write student code
        allow read, write: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
      
      // Leaderboards
      match /Leaderboards/{lessonActivity} {
        match /Scores/{studentId} {
          // Read if owner or enrolled in class
          allow read: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || isEnrolled(classCode);
          // Write by owner (teacher) or the student writing their own score
          allow write: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || (isAuthed() && studentId == request.auth.uid);
        }
      }
      
      // Optional: AttemptRequests
      match /AttemptRequests/{requestId} {
        allow read: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode))) || isEnrolled(classCode);
        allow create: if isEnrolled(classCode);
        allow update, delete: if isOwner(get(/databases/$(database)/documents/Classes/$(classCode)));
      }
    }
  }
}
